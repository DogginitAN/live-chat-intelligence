<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Chat Intelligence</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .animate-marquee { animation: marquee 30s linear infinite; }
        .animate-marquee:hover { animation-play-state: paused; }
        @keyframes ping-once { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(1.5); opacity: 0; } }
        .animate-ping-once { animation: ping-once 1s ease-out forwards; }
        @keyframes slide-in { 0% { transform: translateX(-20px); opacity: 0; } 100% { transform: translateX(0); opacity: 1; } }
        .animate-slide-in { animation: slide-in 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-950">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        const WS_URL = 'ws://localhost:8765';
        const MAX_PULSES = 7;  // Show ~14 minutes of history (7 x 2min)
        
        function ChatVisualization() {
            const [topics, setTopics] = useState({});
            const [questions, setQuestions] = useState([]);
            const [vibeComments, setVibeComments] = useState([]);
            const [pulses, setPulses] = useState([]);  // Chat pulse summaries
            const [velocity, setVelocity] = useState(0);
            const [recentMessages, setRecentMessages] = useState([]);
            const [connected, setConnected] = useState(false);
            const [error, setError] = useState(null);
            const wsRef = useRef(null);
            
            useEffect(() => {
                function connect() {
                    const ws = new WebSocket(WS_URL);
                    ws.onopen = () => { setConnected(true); setError(null); };
                    ws.onmessage = (e) => handleMessage(JSON.parse(e.data));
                    ws.onerror = () => setError('Connection error');
                    ws.onclose = () => { setConnected(false); setTimeout(connect, 3000); };
                    wsRef.current = ws;
                }
                connect();
                return () => wsRef.current?.close();
            }, []);
            
            const handleMessage = useCallback((message) => {
                const now = Date.now();
                if (message.type === 'message') {
                    const data = message.data;
                    if (data.topic) {
                        setTopics(prev => {
                            const existing = prev[data.topic] || { count: 0, sentiment: { bullish: 0, bearish: 0, neutral: 0 }, lastUpdate: now, lastSentiment: data.sentiment, comments: [] };
                            return { ...prev, [data.topic]: { count: existing.count + 1, sentiment: { ...existing.sentiment, [data.sentiment]: existing.sentiment[data.sentiment] + 1 }, lastUpdate: now, lastSentiment: data.sentiment, comments: [...existing.comments.slice(-4), { text: data.text, sentiment: data.sentiment }] } };
                        });
                    }
                    if (data.isQuestion) {
                        const questionTopic = data.topic || 'GENERAL';
                        const questionKey = data.topic || data.text.slice(0, 30);  // Use text snippet as key for general questions
                        setQuestions(prev => {
                            const existing = prev.find(q => q.key === questionKey);
                            if (existing) return prev.map(q => q.key === questionKey ? { ...q, count: q.count + 1, text: data.text, author: data.author, time: now } : q);
                            return [...prev.slice(-4), { key: questionKey, topic: questionTopic, text: data.text, author: data.author, count: 1, time: now }];
                        });
                    }
                    setRecentMessages(prev => [...prev.slice(-20), now]);
                }
                if (message.type === 'vibe' && message.data.vibe) {
                    setVibeComments(prev => [...prev.slice(-15), { text: message.data.text, vibe: message.data.vibe, time: now, id: now + Math.random() }]);
                }
                if (message.type === 'pulse' && message.data.summary) {
                    setPulses(prev => [
                        { ...message.data, id: now + Math.random(), time: now },
                        ...prev.slice(0, MAX_PULSES - 1)  // Keep most recent on left
                    ]);
                }
            }, []);
            
            useEffect(() => {
                const interval = setInterval(() => {
                    const now = Date.now();
                    setVelocity(recentMessages.filter(t => now - t < 5000).length / 5);
                }, 500);
                return () => clearInterval(interval);
            }, [recentMessages]);
            
            useEffect(() => {
                const interval = setInterval(() => setQuestions(prev => prev.filter(q => Date.now() - q.time < 30000)), 5000);
                return () => clearInterval(interval);
            }, []);
            
            const getContestLevel = (s) => { const t = s.bullish + s.bearish; return t === 0 ? 0 : Math.min(s.bullish, s.bearish) / Math.max(s.bullish, s.bearish); };
            const getBullishRatio = (s) => { const t = s.bullish + s.bearish; return t === 0 ? 0.5 : s.bullish / t; };
            const getVelocityLabel = () => velocity < 0.5 ? { text: 'Quiet', color: '#64748b' } : velocity < 2 ? { text: 'Active', color: '#3b82f6' } : velocity < 4 ? { text: 'Busy', color: '#f59e0b' } : { text: 'HYPE', color: '#ef4444' };
            
            const velocityInfo = getVelocityLabel();
            const sortedTopics = Object.entries(topics).sort((a, b) => b[1].count - a[1].count).slice(0, 24);
            const maxCount = Math.max(...sortedTopics.map(([_, d]) => d.count), 1);
            const now = Date.now();
            
            return (
                <div className="min-h-screen bg-gray-950 text-white p-6 pb-48 font-sans">
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h1 className="text-2xl font-light text-gray-300">Live Chat Intelligence</h1>
                            <p className="text-sm">{connected ? <span className="text-green-500">‚óè Connected</span> : <span className="text-red-500">‚óè Disconnected</span>}</p>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="text-right">
                                <div className="text-xs text-gray-500 uppercase">Chat Velocity</div>
                                <div className="text-2xl font-bold" style={{ color: velocityInfo.color }}>{velocityInfo.text}</div>
                            </div>
                            <div className="w-24 h-24 relative">
                                <svg className="w-full h-full -rotate-90">
                                    <circle cx="48" cy="48" r="40" fill="none" stroke="#1e293b" strokeWidth="8" />
                                    <circle cx="48" cy="48" r="40" fill="none" stroke={velocityInfo.color} strokeWidth="8" strokeDasharray={`${Math.min(velocity / 5, 1) * 251} 251`} className="transition-all duration-500" />
                                </svg>
                                <div className="absolute inset-0 flex items-center justify-center"><span className="text-lg font-mono">{velocity.toFixed(1)}/s</span></div>
                            </div>
                        </div>
                    </div>
                    <div className="flex gap-6 mb-6 text-xs text-gray-500">
                        <div className="flex items-center gap-2"><div className="w-8 h-2 rounded-full bg-green-500" /><span>Bullish</span></div>
                        <div className="flex items-center gap-2"><div className="w-8 h-2 rounded-full bg-gradient-to-r from-green-500 to-red-500" /><span>Contested</span></div>
                        <div className="flex items-center gap-2"><div className="w-8 h-2 rounded-full bg-red-500" /><span>Bearish</span></div>
                    </div>
                    <div className="flex gap-6">
                        <div className="flex-1">
                            <div className="text-xs text-gray-500 uppercase mb-4">Topic Clusters</div>
                            {sortedTopics.length === 0 ? <div className="text-gray-600 italic">Waiting for ticker mentions...</div> : (
                                <div className="flex flex-wrap gap-3 items-end">
                                    {sortedTopics.map(([topic, data], index) => {
                                        const contestLevel = getContestLevel(data.sentiment);
                                        const bullishRatio = getBullishRatio(data.sentiment);
                                        const isContested = contestLevel > 0.5;
                                        // Organic growth: start at 70px, grow with log of count, max ~130px
                                        const baseSize = 70;
                                        const growthFactor = Math.log2(data.count + 1) * 15; // +15px per doubling
                                        const size = Math.min(130, baseSize + growthFactor);
                                        const isRecent = now - data.lastUpdate < 2000;
                                        const flashColor = data.lastSentiment === 'bullish' ? 'rgb(34, 197, 94)' : data.lastSentiment === 'bearish' ? 'rgb(239, 68, 68)' : 'rgb(148, 163, 184)';
                                        const bgColor = isContested ? 'rgba(100, 100, 100, 0.15)' : bullishRatio > 0.5 ? `rgba(34, 197, 94, ${0.1 + bullishRatio * 0.15})` : `rgba(239, 68, 68, ${0.1 + (1 - bullishRatio) * 0.15})`;
                                        return (
                                            <div key={topic} className="relative group cursor-pointer transition-all duration-500">
                                                {isContested && <div className="absolute inset-0 rounded-full blur-xl animate-pulse" style={{ background: 'linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(239, 68, 68, 0.3))' }} />}
                                                {isRecent && <div className="absolute inset-0 rounded-full blur-xl opacity-60 animate-ping-once" style={{ backgroundColor: flashColor }} />}
                                                <div className="relative rounded-full flex flex-col items-center justify-center transition-all duration-500 hover:scale-110 overflow-hidden" style={{ width: `${size}px`, height: `${size}px`, backgroundColor: bgColor, border: `2px solid ${isRecent ? flashColor : (isContested ? '#6b7280' : (bullishRatio > 0.5 ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)'))}`, boxShadow: isRecent ? `0 0 30px ${flashColor}` : 'none' }}>
                                                    <span className="font-bold" style={{ fontSize: `${Math.max(12, size / 6)}px`, color: isContested ? '#e5e7eb' : (bullishRatio > 0.5 ? '#4ade80' : '#f87171') }}>{topic}</span>
                                                    <span className="font-light text-white" style={{ fontSize: `${Math.max(14, size / 4)}px` }}>{data.count}</span>
                                                    {size >= 90 && (
                                                        <>
                                                            <div className="absolute bottom-2 left-2 right-2 h-2 bg-gray-800 rounded-full overflow-hidden">
                                                                <div className="absolute left-0 top-0 bottom-0 bg-gradient-to-r from-green-600 to-green-400 transition-all duration-500" style={{ width: `${bullishRatio * 100}%` }} />
                                                                <div className="absolute right-0 top-0 bottom-0 bg-gradient-to-l from-red-600 to-red-400 transition-all duration-500" style={{ width: `${(1 - bullishRatio) * 100}%` }} />
                                                            </div>
                                                            <div className="absolute bottom-5 left-2 right-2 flex justify-between text-xs font-mono">
                                                                <span className="text-green-400" style={{ fontSize: '10px' }}>{data.sentiment.bullish}</span>
                                                                <span className="text-red-400" style={{ fontSize: '10px' }}>{data.sentiment.bearish}</span>
                                                            </div>
                                                        </>
                                                    )}
                                                </div>
                                                {isContested && <div className="absolute -top-1 -right-1 bg-yellow-500 text-black text-xs font-bold px-1 py-0.5 rounded-full" style={{ fontSize: '10px' }}>‚öîÔ∏è</div>}
                                                <div className={`absolute top-full mt-2 w-64 bg-gray-900 border border-gray-700 rounded-lg p-3 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 ${index < 8 ? 'left-0' : 'left-1/2 -translate-x-1/2'}`}>
                                                    <div className="flex justify-between text-xs text-gray-400 mb-2"><span>Recent:</span><span>{Math.round(bullishRatio * 100)}% bullish</span></div>
                                                    {data.comments.map((c, i) => <div key={i} className="flex gap-2 text-sm"><span className={c.sentiment === 'bullish' ? 'text-green-400' : c.sentiment === 'bearish' ? 'text-red-400' : 'text-gray-400'}>{c.sentiment === 'bullish' ? '‚ñ≤' : c.sentiment === 'bearish' ? '‚ñº' : '‚Ä¢'}</span><span className="text-gray-300 truncate">"{c.text}"</span></div>)}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                        <div className="w-80">
                            <div className="text-xs text-gray-500 uppercase mb-4">Questions <span className="text-yellow-500">‚óè Live</span></div>
                            <div className="space-y-3">
                                {questions.length === 0 ? <div className="text-gray-600 text-sm italic">No questions yet...</div> : questions.map((q, i) => (
                                    <div key={`${q.topic}-${i}`} className="bg-gray-900 border border-yellow-900 rounded-lg p-4" style={{ opacity: Math.max(0.4, 1 - (now - q.time) / 30000), borderColor: now - q.time < 3000 ? 'rgb(234, 179, 8)' : 'rgb(113, 63, 18)' }}>
                                        <div className="flex justify-between items-start mb-2">
                                            <span className="text-yellow-500 font-medium">{q.topic}</span>
                                            {q.count > 1 && <span className="bg-yellow-900 text-yellow-300 text-xs px-2 py-1 rounded-full">x{q.count} asking</span>}
                                        </div>
                                        <p className="text-gray-300 text-sm mb-2">"{q.text}"</p>
                                        <p className="text-gray-500 text-xs">@{q.author}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="fixed bottom-0 left-0 right-0 bg-gradient-to-t from-gray-950 via-gray-950 to-transparent pt-8 pb-4">
                        <div className="px-6">
                            {/* Chat Pulse - sliding pills */}
                            <div className="mb-4">
                                <div className="flex items-center gap-3 mb-2">
                                    <span className="text-xs text-gray-500 uppercase">Chat Pulse</span>
                                    <span className="text-xs text-gray-600">‚Üê newest</span>
                                </div>
                                <div className="flex gap-3 overflow-hidden">
                                    {pulses.length === 0 ? (
                                        <div className="text-gray-600 text-sm italic py-4">Generating first summary...</div>
                                    ) : (
                                        pulses.map((pulse, i) => {
                                            const age = (now - pulse.time) / 1000 / 60; // minutes
                                            const opacity = Math.max(0.4, 1 - (age / 15)); // Fade over 15 min
                                            return (
                                                <div
                                                    key={pulse.id}
                                                    className={`flex-shrink-0 px-4 py-3 rounded-xl border transition-all duration-500 ${i === 0 ? 'animate-slide-in' : ''}`}
                                                    style={{
                                                        opacity,
                                                        backgroundColor: 'rgba(30, 41, 59, 0.8)',
                                                        borderColor: i === 0 ? 'rgba(59, 130, 246, 0.5)' : 'rgba(71, 85, 105, 0.5)',
                                                        boxShadow: i === 0 ? '0 0 20px rgba(59, 130, 246, 0.2)' : 'none',
                                                        maxWidth: '280px'
                                                    }}
                                                >
                                                    <div className="flex items-start gap-2">
                                                        <span className="text-lg">{pulse.mood}</span>
                                                        <div>
                                                            <p className="text-sm text-gray-200 leading-snug">{pulse.summary}</p>
                                                            <div className="flex items-center gap-2 mt-1">
                                                                {pulse.top_ticker && (
                                                                    <span className="text-xs px-1.5 py-0.5 rounded bg-blue-900/50 text-blue-300">
                                                                        ${pulse.top_ticker}
                                                                    </span>
                                                                )}
                                                                <span className="text-xs text-gray-500">
                                                                    {age < 1 ? 'just now' : `${Math.round(age)}m ago`}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </div>
                            
                            {/* Divider */}
                            <div className="my-5 border-t border-gray-800/50" />
                            
                            {/* Community Vibes ticker */}
                            <div className="flex items-center gap-3 mb-2">
                                <span className="text-xs text-gray-500 uppercase">Community Vibes</span>
                                <span className="text-xs px-2 py-0.5 rounded-full bg-purple-900 text-purple-300">üòÇ Funny</span>
                                <span className="text-xs px-2 py-0.5 rounded-full bg-pink-900 text-pink-300">üíñ Uplifting</span>
                            </div>
                            <div className="relative overflow-hidden h-12 bg-gray-900/50 rounded-lg border border-gray-800">
                                <div className="absolute whitespace-nowrap animate-marquee flex items-center h-full gap-8 px-4">
                                    {vibeComments.length === 0 ? <span className="text-gray-600 italic">Waiting for vibes...</span> : (
                                        <>{vibeComments.concat(vibeComments).map((c, i) => (
                                            <div key={`${c.id}-${i}`} className="flex items-center gap-2 px-3 py-1 rounded-full" style={{ backgroundColor: c.vibe === 'funny' ? 'rgba(147, 51, 234, 0.2)' : 'rgba(236, 72, 153, 0.2)', border: `1px solid ${c.vibe === 'funny' ? 'rgba(147, 51, 234, 0.4)' : 'rgba(236, 72, 153, 0.4)'}` }}>
                                                <span>{c.vibe === 'funny' ? 'üòÇ' : 'üíñ'}</span>
                                                <span className="text-gray-200 text-sm">{c.text}</span>
                                            </div>
                                        ))}</>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<ChatVisualization />);
    </script>
</body>
</html>
